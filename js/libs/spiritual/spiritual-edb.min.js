!function(e){"use strict";e.edb=gui.namespace("edb",{version:"0.1.6",debug:!1,$accessaware:!1,BROADCAST_ACCESS:"edb-broadcast-access",BROADCAST_CHANGE:"edb-broadcast-change",BROADCAST_OUTPUT:"edb-broadcast-output",BROADCAST_SCRIPT_INVOKE:"edb-broadcast-script-invoke",TICK_SCRIPT_UPDATE:"edb-tick-script-update",TICK_COLLECT_INPUT:"edb-tick-collect-input",TICK_PUBLISH_CHANGES:"edb-tick-update-changes",get:function(e,t,n){var i=edb.Output.$get(e);return i?(t&&t.call(n,i.data),i.data):(t&&console.error("TODO: callback support!"),null)}}),edb.Type=gui.Class.create(null,{onconstruct:function(){},ondestruct:function(){},output:function(){return edb.Output.dispatch(this),this},outputGlobal:function(){return edb.Output.dispatchGlobal(this),this},revoke:function(){return edb.Output.revoke(this),this},dispose:function(){edb.Type.$destruct(this)},serializeToString:function(e,t){return(new edb.Serializer).serializeToString(this,e,t)},$originalid:null,$destructed:!1,$onconstruct:function(){},$ondestruct:function(){this.constructor.storage&&this.persist()}}),edb.Type.mixin(null,null,{is:function(e){return edb.Object.is(e)||edb.Array.is(e)},isConstructor:function(e){return gui.Type.isGuiClass(e)&&gui.Class.ancestorsAndSelf(e).some(function(e){return e===edb.Object||e===edb.Array})},lookup:function(e,t){var n=null;switch(gui.Type.of(t)){case"function":n=t;break;case"string":n=gui.Object.lookup(t,e);break;case"object":console.error(this+": expected edb.Type constructor (not an object)")}if(!n)throw new TypeError('The type "'+t+'" does not exist');return n},cast:function(e){if(gui.Type.isComplex(e)&&!edb.Type.is(e))switch(gui.Type.of(e)){case"object":return edb.Object.from(e);case"array":return edb.Array.from(e)}return e},mixin:function(e,t,n){[edb.Object,edb.Array].forEach(function(i){i.mixin(e,t,n)})},$observe:function(e,t){var n=e.$instanceid,i=this._observers,r=i[n]||(i[n]=[]);return-1===r.indexOf(t)&&r.push(t),e},$unobserve:function(e,t){var n,i=e.$instanceid,r=this._observers,s=r[i];return s&&(n=s.indexOf(t))>-1&&0===gui.Array.remove(s,n)&&delete r[i],e},$destruct:function(e){(new edb.Crawler).crawl(e,{ontype:function(t){t.$destructed||(e.ondestruct(),e.$ondestruct(),e.$destructed=!0,gui.unloading||gui.GreatSpirit.$nukeallofit(e))}})}}),function(){var e={out:function(){return edb.Output.out(this)}},t={from:gui.Arguments.confirmed("(string|object|array|null)")(function(e){var t=this;return e&&(edb.Type.is(e)&&(e=(new edb.Serializer).serializeToString(e)),gui.Type.isString(e)&&(e.contains("$object")||e.contains("$array"))&&(e=(new edb.Parser).parseFromString(e,null))),new t(e)})};[e,t].forEach(function(e){gui.Object.each(e,function(e,t){edb.Type[e]=t})}),edb.Type.$staticmixins=function(){var n={};return[e,t].forEach(function(e){Object.keys(e).forEach(function(t){n[t]=e[t]},this)},this),n}}(),edb.Object=function(e){return gui.Class.create(Object.prototype,{addObserver:e(function(e){edb.Object.observe(this,e)}),removeObserver:e(function(e){edb.Object.unobserve(this,e)}),$onconstruct:function(e){switch(edb.Type.prototype.$onconstruct.apply(this,arguments),gui.Type.of(e)){case"object":case"undefined":case"null":var t=gui.Object.copy(e||{}),n=edb.ObjectPopulator.populate(t,this);edb.ObjectProxy.approximate(t,this,n);break;default:throw new TypeError("Unexpected edb.Object constructor argument of type "+gui.Type.of(e)+": "+String(e))}this.onconstruct(),this.oninit&&console.error("Deprecated API is deprecated: "+this+".oninit")},toJSON:function(){return gui.Object.map(this,function(e,t){var n=e.charAt(0);return"$"!==n&&"_"!==n?edb.Type.is(t)?t.toJSON():t:void 0})}})}(gui.Combo.chained),edb.Object.mixin(null,edb.Type.$staticmixins(),{observe:edb.Type.$observe,unobserve:edb.Type.$unobserve,ontick:function(e){var t,n,i,r=this._observers;e.type===edb.TICK_PUBLISH_CHANGES&&(t=gui.Object.copy(this._changes),this._changes=Object.create(null),gui.Object.each(t,function(e){(i=r[e])&&(n=[],gui.Object.each(t,function(t,i){t===e&&gui.Object.each(i,function(e,t){n.push(t)})}),i.forEach(function(e){e.onchange(n)}))}))},$onaccess:function(e,t){edb.$accessaware&&gui.Broadcast.dispatch(edb.BROADCAST_ACCESS,[e,t])},$onchange:function(e,t,n,i){var r=edb.ObjectChange.TYPE_UPDATE,s=this._changes,o=e.$instanceid,u=s[o]=s[o]||(s[o]=Object.create(null));u[t]=new edb.ObjectChange(e,t,r,n,i),gui.Tick.dispatch(edb.TICK_PUBLISH_CHANGES)},_observers:Object.create(null),_changes:Object.create(null)}),function(){gui.Tick.add(edb.TICK_PUBLISH_CHANGES,edb.Object),gui.Object.extendmissing(edb.Object.prototype,edb.Type.prototype)}(),function(e,t){function n(e,t){return edb.ArrayPopulator.convert(e,t)}function i(e,t,n,i){edb.Array.$onchange(e,t,n,i)}function r(e){var t=e.$instanceid;return edb.Array._observers[t]?!0:!1}edb.Array=gui.Class.create(e,{push:function(){var t=this.length,s=n(this,arguments),o=e.push.apply(this,s);return r(this)&&i(this,t,null,s),o},pop:function(){var t=this.length-1,n=e.pop.apply(this);return r(this)&&t>=0&&i(this,t,[n],null),n},shift:function(){var t=e.shift.apply(this);return r(this)&&i(this,0,[t],null),t},unshift:function(){var t=n(this,arguments),s=e.unshift.apply(this,t);return r(this)&&i(this,0,null,t),s},splice:function(){var t=arguments,s=t[0],o=n(this,[].slice.call(t,2)),u=[s,t[1]].concat(o),a=e.splice.apply(this,u);return r(this)&&i(this,s,a,o),a},reverse:function(){if(r(this)){var t=this.toJSON(),n=e.reverse.apply(t.slice());i(this,0,t,n)}return e.reverse.apply(this)},onconstruct:function(){},addObserver:t(function(e){edb.Object.observe(this,e),edb.Array.observe(this,e)}),removeObserver:t(function(e){edb.Object.unobserve(this,e),edb.Array.unobserve(this,e)}),$of:null,$onconstruct:function(){var e,t;edb.Type.prototype.$onconstruct.apply(this,arguments),arguments.length&&(e=arguments[0]?arguments[0].$object||{}:{},t=edb.ObjectPopulator.populate(e,this),edb.ArrayPopulator.populate(this,arguments),edb.ObjectProxy.approximate(e,this,t)),this.onconstruct([].slice.call(this))},get:function(e){return edb.$accessaware&&edb.Array.$onaccess(this,e),this[e]},getLength:function(e){return edb.$accessaware&&edb.Array.$onaccess(this,e),this.length},setLength:function(e){for(var t=[];this.length>e;)t.push(this.pop());t.length&&i(this,this.length-1,t)},toJSON:function(){return Array.map(this,function(e){return edb.Type.is(e)?e.toJSON():e})}})}(Array.prototype,gui.Combo.chained),edb.Array.mixin(null,edb.Type.$staticmixins(),{observe:edb.Type.$observe,unobserve:edb.Type.$unobserve,isConstructor:function(e){return gui.Type.isConstructor(e)&&gui.Class.ancestorsAndSelf(e).indexOf(edb.Array)>-1},ontick:function(e){var t,n,i=this._observers;e.type===edb.TICK_PUBLISH_CHANGES&&(t=gui.Object.copy(this._changes),this._changes=Object.create(null),gui.Object.each(t,function(e,t){(n=i[e])&&n.forEach(function(e){e.onchange(t)})}))},_observers:Object.create(null),_changes:Object.create(null),$onaccess:function(e){edb.$accessaware&&gui.Broadcast.dispatch(edb.BROADCAST_ACCESS,[e])},$onchange:function(e,t,n,i){var r=e.$instanceid,s=this._changes,o=s[r]||(s[r]=[]);o.push(new edb.ArrayChange(e,t,n,i)),gui.Tick.dispatch(edb.TICK_PUBLISH_CHANGES)}}),function(e){function t(e,t){t.forEach(function(t){e[t]=n(e[t])})}var n=gui.Combo.before(function(){edb.$accessaware&&edb.Array.$onaccess(this,-1)});t(e,["filter","forEach","every","map","some","indexOf","lastIndexOf","slice"])}(edb.Array.prototype),function(){gui.Tick.add(edb.TICK_PUBLISH_CHANGES,edb.Array),gui.Object.extendmissing(edb.Array.prototype,edb.Type.prototype)}(),edb.ObjectPopulator=function(e,t,n,i){function r(e){var t=edb.Object.is(e)?edb.Object:edb.Array,n=edb.Object.is(e)?Object:Array,i=[],r=[edb.Type,t,n];return gui.Object.all(e,function(e){a(e)&&r.every(function(t){return void 0===t.prototype[e]})&&i.push(e)}),i}function s(e,t){var n=e.$originalid||e.$instanceid;delete e.$instanceid,delete e.$originalid,n&&Object.defineProperty(t,"$originalid",gui.Property.nonenumerable({value:n}))}function o(e,t){throw new TypeError(e+' declares "'+t+'" as something undefined')}function u(e,t){throw new TypeError(e+' "'+t+'" must resolve to a constructor')}function a(e){return e.match(/^[a-z]/i)}function c(e,t){return e.hasOwnProperty(t)?Object.getOwnPropertyDescriptor(e,t):(e=Object.getPrototypeOf(e))?c(e,t):null}return{populate:function(d,l){var h,p,f,b,g=Object.create(null),y=l.constructor.prototype,_=l.constructor.$classname;return s(d,l),r(l).forEach(function(r){switch(p=l[r],f=d[r],p){case Object:l[r]={};break;case Array:l[r]=f&&Array.isArray(f)?f.slice():[];break;default:e(f)?e(p)?t(p)&&(n(p)?(i(p)||(p=p(f)),i(p)?null!==f&&(h=p,g[r]=h.from(d[r])):u(_,r)):g[r]=edb.Type.cast(e(f)?f:p)):o(_,r):a(r)&&edb.Type.isConstructor(p)?(d[r]=edb.Array.isConstructor(p)?[]:null,h=p,g[r]=h.from(d[r])):(b=c(y,r))&&Object.defineProperty(d,r,b)}}),gui.Object.nonmethods(d).forEach(function(e){var t=d[e];a(e)&&gui.Type.isComplex(t)&&(g[e]||(g[e]=edb.Type.cast(t)))}),g}}}(gui.Type.isDefined,gui.Type.isComplex,gui.Type.isFunction,gui.Type.isConstructor),edb.ArrayPopulator=function(){function e(e){return e.$of&&e.$of.prototype.reverse}function t(e){return Array.isArray(e)||edb.Array.is(e)}function n(e,t){if(!gui.debug||edb.Type.isConstructor(e)){if(!edb.Type.is(t))return new e(t);if(e.is(t))return t;r(e,t)}else r("edb.Type",e)}function i(e,t){var i=e(t);return gui.Type.isConstructor(i)?i=n(i,t):edb.Type.is(i)||null===i?i=i:r("edb.Type constructor or instance",gui.Type.of(i),"return null for nothing"),i}function r(e,t,n){throw new TypeError("$of expected "+e+", got "+t+(n?" ("+n+")":""))}function s(e,t){return e.map(function(e){return void 0!==e&&(e=gui.Type.isConstructor(t.$of)?n(t.$of,e):i(function(e){return t.$of(e)},e)),e})}function o(e){return e.map(function(e){if(!edb.Type.is(e))switch(gui.Type.of(e)){case"object":return new edb.Object(e);case"array":return new edb.Array(e)}return e})}return{populate:function(n,i){var r=i[0];r&&(!e(n)&&t(r)&&(i=r),Array.prototype.push.apply(n,this.convert(n,i)))},convert:function(e,t){if(t=gui.Array.from(t),gui.Type.isNull(e.$of))return o(t);if(gui.Type.isFunction(e.$of))return s(t,e);var n=gui.Type.of(e.$of);throw new Error(e+" cannot be $of "+n)}}}(),edb.ObjectProxy=function(){function e(e,t){return function(){var i=t.apply(this);return edb.$accessaware&&!n&&edb.Object.$onaccess(this,e),i}}function t(e,t){return function(i){n=!0;var r=this[e];t.apply(this,arguments),(i=this[e])!==r&&edb.Object.$onchange(this,e,r,i),n=!1}}var n=!1;return{approximate:function(n,i,r){gui.Object.nonmethods(n).forEach(function(s){var o=Object.getOwnPropertyDescriptor(n,s);o.configurable&&Object.defineProperty(i,s,{enumerable:o.enumerable,configurable:o.configurable,get:e(s,function(){return o.get?o.get.call(this):r[s]||n[s]}),set:t(s,function(e){var t,i;o.set?o.set.call(this,e):(i=r[s])?edb.Type.is(e)?r[s]=e:(t=i.constructor,r[s]=t.from(e)):n[s]=edb.Type.cast(e)})})}),gui.Object.ownmethods(n).forEach(function(e){i[e]=n[e]})}}}(),edb.Change=function(){},edb.Change.prototype={object:null,type:null},edb.ObjectChange=function(e,t,n,i,r){this.object=e,this.name=t,this.type=n,this.oldValue=i,this.newValue=r},edb.ObjectChange.prototype={name:null,oldValue:void 0,newValue:void 0},edb.ObjectChange.TYPE_UPDATE="update",edb.ArrayChange=function(e,t,n,i){this.type=edb.ArrayChange.TYPE_SPLICE,this.object=e,this.index=t,this.removed=n||[],this.added=i||[]},edb.ArrayChange.prototype=gui.Object.create(edb.Change.prototype,{index:-1,removed:null,added:null}),edb.ArrayChange.TYPE_SPLICE="splice",edb.ArrayChange.toSpliceParams=function(e){if(e.type===edb.ArrayChange.TYPE_SPLICE){var t=e.index,n=e.removed.length,i=e.added;return[t,n].concat(i)}throw new TypeError},edb.Input=function(e,t){if(this.$instanceid=gui.KeyMaster.generateKey(),!edb.Type.is(t)&&null!==t)throw new TypeError(t+" is not a Type instance");this.type=e,this.data=t},edb.Input.prototype={type:null,data:null,revoked:!1,$instanceid:null,toString:function(){return"[object edb.Input]"}},edb.Output={toString:function(){return"[object edb.Output]"},dispatch:function(e,t){var n,i=this._configure(e.constructor,e);t?(console.error("Deprecated API is deprecated",t.spirit),(n=t.$oninput||t.oninput)&&n.call(t,i)):gui.Broadcast.dispatch(edb.BROADCAST_OUTPUT,i)},revoke:function(e){var t=edb.Type.is(e)?e.constructor:e;if(edb.get(t)===e){var n=this._configure(t,null);gui.Broadcast.dispatch(edb.BROADCAST_OUTPUT,n),delete this._map[t.$classid]}},out:function(e){if(e){if(this._map){var t=e.$classid,n=this._map[t];return n?!0:!1}return!1}throw new Error("Something is undefined")},_map:{},_configure:function(e,t){var n=e.$classid;return this._map[n]=t,new edb.Input(e,t)},$get:function(e){if(e){if(this._map){var t=e.$classid,n=this._map[t];return n?new edb.Input(n.constructor,n):null}return null}throw new Error("Something undefined was requested")}},edb.Crawler=function(){function e(){}function t(e,r){gui.Object.each(e,n).forEach(function(e){i(e,r),t(e,r)})}function n(e,t){return edb.Type.is(t)?t:void 0}function i(e,t){t.ontype&&t.ontype(e),t.onarray&&edb.Array.is(e)&&t.onarray(e),t.onobject&&edb.Object.is(e)&&t.onobject(e)}return e.prototype={crawl:function(e,n){if(!edb.Type.is(e))throw new TypeError;i(e,n),t(e,n)}},e}(),edb.Serializer=function(){function e(){}function t(e){return edb.Type.is(e)}function n(e){return edb.Array.is(e)}function i(e){return n(e)?s(e):r(e)}function r(e){var t=gui.Object.map(e,o,e);return{$object:gui.Object.extend({$classname:e.$classname,$instanceid:e.$instanceid,$originalid:e.$originalid},t)}}function s(e){return gui.Object.extend(r(e),{$array:u(e)})}function o(e,r){var s=e.charAt(0);if("_"===s||"$"===s)return void 0;if(n(this)&&e.match(a))return void 0;if(t(r))return i(r);if(gui.Type.isComplex(r)){switch(r.constructor){case Object:case Array:return r}return void 0}if(t(this)){var o=this.constructor.prototype,u=Object.getOwnPropertyDescriptor(o,e);if(u&&(u.set||u.get))return void 0}return r}function u(e){return Array.map(e,function(e){return t(e)?i(e):e})}e.prototype={serializeToString:function(e,n,r){if(t(e))return JSON.stringify(i(e),n,r);throw new TypeError("Expected edb.Object|edb.Array")}};var a=/^length|^\d+/;return e}(),edb.Parser=function(){function e(){}function t(e,t){var n,i;if(null===t||(t?(i=t.$classname||i,n=i?t:gui.Object.lookup(i)):(i=e.$object.$classname,n=gui.Object.lookup(i))),e=o(e),null===t)return e;if(n)return n.from(e);var r=new TypeError(i+" is not defined");throw i===gui.Class.ANONYMOUS&&console.error('TODO: Spiritual should make sure that nothing is ever "'+i+'"\n'+JSON.stringify(e,null,4)),r}function n(e){return gui.Type.isComplex(e)&&(e.$array||e.$object)}function i(e){return gui.Object.map(e.$object,s)}function r(e){var t=e.$array.map(o);return t.$object=e.$object,t}function s(e,t){switch(e){case"$classname":return void 0;default:return o(t)}}function o(e){return n(e)?e.$array?r(e):i(e):e}return e.prototype={parseFromString:function(e,i){try{e=JSON.parse(e)}catch(r){throw new TypeError("Bad JSON: "+r.message)}finally{if(n(e))return t(e,i);throw new TypeError("Expected serialized edb.Object|edb.Array")}}},e}(),edb.InputPlugin=gui.Tracker.extend({done:!0,onconstruct:function(){this._super.onconstruct(),this.context=self,this._watches=[],this._matches=[],this._needing=[]},ondestruct:function(){this._super.ondestruct(),this.remove(this._watches)},add:gui.Combo.chained(function(e,t,n){t=t?t:this.spirit,e=edb.InputPlugin._breakdown(e,this.context),e.length&&(this.done=this.done&&n===!1,this._add(e,t,n),this._subscribe(!0))}),remove:gui.Combo.chained(function(e,t){t=t?t:this.spirit,e=edb.InputPlugin._breakdown(e,this.context),e.length&&(this._remove(e,t),this.done=this._done())}),get:function(e){var t=this._matches.map(function(e){return e.data.constructor}),n=edb.InputPlugin._bestmatch(e,t,!1),i=n?this._matches.filter(function(e){return e.type===n}).shift():null;return i?i.data:null},onbroadcast:function(e){e.type===edb.BROADCAST_OUTPUT&&this.$oninput(e.data)},match:function(e){var t=!this._matches.length;return t||this._matches.every(function(t){return t.$instanceid!==e.$instanceid})?this._maybeinput(e):!1},$oninput:function(e){return null===e.data?(this._mayberevoke(e),!1):this.match(e)},_watches:null,_matches:null,_needing:null,_add:function(e,t,n){e.forEach(function(e){if(!gui.Type.isDefined(e))throw new TypeError("Could not register input for undefined Type");this._addchecks(e.$classid,[t]),this._watches.push(e),n&&this._needing.push(e)},this),e.forEach(function(e){gui.Class.descendantsAndSelf(e,function(e){e.out(this.context)&&this._maybeinput(edb.Output.$get(e))},this)},this)},_remove:function(e,t){e.forEach(function(e){gui.Array.remove(this._watches,e),gui.Array.remove(this._needing,e),this._removechecks(e.$classid,[t]),this._watches.length||this._subscribe(!1)},this)},_maybeinput:function(e){var t=edb.InputPlugin._bestmatch(e.type,this._watches,!0);return t?(this._updatematch(e,t),this.done=this._done(),this._updatehandlers(e),!0):!1},_mayberevoke:function(e){var t=this._matches,n=this._watches,i=edb.InputPlugin._bestmatch(e.type,n,!0);if(i){var r=t.filter(function(e){return e.type===i})[0],s=t.indexOf(r);t.splice(s,1),this.done=this._done(),this.done||(e.revoked=!0,this._updatehandlers(e))}},_updatematch:function(e,t){var n=this._matches,i=-1,r=-1,s=edb.InputPlugin._rateone(e.type,t);n.forEach(function(e,n){r=edb.InputPlugin._rateone(e.type,t),r>-1&&s>=r&&(i=n)}),i>-1?n[i]=e:n.push(e)},_updatehandlers:function(e){gui.Class.ancestorsAndSelf(e.type,function(t){var n=this._trackedtypes[t.$classid];n&&n.forEach(function(t){var n=t[0];n.oninput(e)})},this)},_done:function(){var e=this._needing,t=this._matches;return e.every(function(e){return t.some(function(t){return t.data instanceof e})})},_subscribe:function(e){gui.Broadcast[e?"add":"remove"](edb.BROADCAST_OUTPUT,this)}},{},{_breakdown:function(e,t){return gui.Type.isArray(e)?this._breakarray(e,t):this._breakother(e,t)},_breakarray:function(e,t){return e.map(function(e){switch(gui.Type.of(e)){case"function":return e;case"string":return gui.Object.lookup(e,t);case"object":console.error("Expected function. Got object.")}},this)},_breakother:function(e,t){switch(gui.Type.of(e)){case"function":return[e];case"string":return this._breakarray(e.split(" "),t);case"object":console.error("Expected function. Got object.")}},_bestmatch:function(e,t,n){var i=null,r=Number.MAX_VALUE;return this._rateall(e,t,n,function(e,t){t>-1&&r>t&&(r=t,i=e)}),i},_rateall:function(e,t,n,i){t.forEach(function(t){i(t,this._rateone(n?e:t,n?t:e))},this)},_rateone:function(e,t){var n=0,i=-1,r=e;if(e===t)i=0;else for(;r=gui.Class.parent(r);)n++,r===t&&(r=null,i=n);return i}}),gui.module("edb@wunderbyte.com",{plugin:{input:edb.InputPlugin}}),e.edbml=gui.namespace("edbml",{bootload:!1,declare:function(e){var t,n;return{as:function(i){return t=edbml.$runtimeconfigure(i),n=gui.Object.assert(e,t),n.$bind=function(){console.error("Deprecated API is deprecated: $bind")},n.lock=function(e){return n({$out:e})},this},withInstructions:function(e){n.$instructions=e}}},$set:function(e,t){return this._assign(e,t)},$get:function(e){return this._request(e)},$run:function(e,t){this._register(e),this._invoke(t)},$revoke:function(e){this._invokables[e]=null,delete this._invokables[e]},$runtimeconfigure:function(e){function t(t){return e.$out=t&&t.$out?t.$out:new edbml.Out,e.$att=new edbml.Att,e.apply(this,arguments)}return t.$edbml=e,t},_latestevent:null,_invokables:{},_assign:function(e,t){var n=gui.KeyMaster.generateKey();return this._invokables[n]=function(n,i){return e.apply(t,[gui.Type.cast(n),i])},n},_invoke:function(e,t,n){n=n||this._latestevent,t?this._invokeremote(e,t,n):this._invokelocal(e,n)},_invokeremote:function(e,t,n){gui.Broadcast.$target=this,gui.Broadcast.dispatchGlobal(edb.BROADCAST_SCRIPT_INVOKE,{key:e,sig:t,log:n})},_invokelocal:function(e,t){var n=this._invokables[e];n?t?"click"===t.type?gui.Tick.time(function(){n(t.value,t.checked)}):n(t.value,t.checked):n():console.error("out of synch")},_request:function(e,t){var n;if(t)console.error("Not supported");else{if(n=this._invokables[e])return n();console.error("out of synch")}},_register:function(e){this._latestevent=e?{type:e.type,value:e.target.value,checked:e.target.checked}:null}}),edbml.Att=function(e){e&&gui.Object.extend(this,e)},edbml.Att.prototype=gui.Object.create(null,{toString:function(){return"[object edbml.Att]"},$html:function(e){var t=this[e],n="";switch(gui.Type.of(t)){case"null":case"undefined":break;default:t=edbml.Att.$encode(this[e]),n+=e+'="'+t+'" '}return n},$pop:function(e){var t=this._out(e);return delete this[e],t},$all:function(){var e="";return gui.Object.nonmethods(this).forEach(function(t){e+=this._out(t)},this),e}}),edbml.Att.$encode=function(e){var t=gui.Type.of(e);switch(t){case"string":break;case"number":case"boolean":e=String(e);break;case"object":case"array":try{e=encodeURIComponent(JSON.stringify(e))}catch(n){throw new Error("Could not create HTML attribute: "+n)}break;case"date":throw new Error("TODO: edbml.Att.encode standard date format?");default:throw new Error("Could not create HTML attribute for "+t)}return e},edbml.Out=function(){},edbml.Out.prototype={html:"",toString:function(){return"[object edbml.Out]"},write:function(){return this.html}},edbml.UpdateAssistant={id:function(e){return e.id||null},parse:function(e,t,n,i){i=e.createElement(i.localName),i.innerHTML=t,i.id=n,Array.forEach(i.querySelectorAll("option"),function(e){switch(e.getAttribute("selected")){case"true":e.setAttribute("selected","selected");break;case"false":e.removeAttribute("selected")}});var r="input[type=checkbox],input[type=radio]";return Array.forEach(i.querySelectorAll(r),function(e){switch(e.getAttribute("checked")){case"true":e.setAttribute("checked","checked");break;case"false":e.removeAttribute("checked")}}),i},order:function(e){var t=new Map;return Array.forEach(e,function(e,n){e.nodeType===Node.ELEMENT_NODE&&t.set(this.id(e),n)},this),t},index:function(e){var t=Object.create(null);return Array.forEach(e,function(e){e.nodeType===Node.ELEMENT_NODE&&(t[this.id(e)]=e)},this),t}},edbml.UpdateManager=gui.Class.create(Object.prototype,{onconstruct:function(e){this._keyid=e.dom.id()||e.$instanceid,this._spirit=e,this._doc=e.document},update:function(e){this._spirit.life.destructed||(this._updates=new edbml.UpdateCollector,this._functions={},this._olddom?(this._next(e),this._updates.collect(new edbml.FunctionUpdate(this._doc).setup(this._keyid,this._functions))):this._first(e),this._updates.eachRelevant(function(e){e.update(),e.dispose()}),this._updates&&this._updates.dispose(),this._updates=null)},_keyid:null,_doc:null,_spirit:null,_olddom:null,_nedwdom:null,_updates:null,_assistant:edbml.UpdateAssistant,_first:function(e){this._olddom=this._parse(e),this._updates.collect(new edbml.HardUpdate(this._doc).setup(this._keyid,this._olddom))},_next:function(e){this._newdom=this._parse(e),this._crawl(this._newdom,this._olddom,this._newdom,this._keyid,{}),this._olddom=this._newdom},_parse:function(e){return this._assistant.parse(this._doc,e,this._keyid,this._spirit.element)},_crawl:function(e,t,n,i,r){for(var s=!0;e&&t&&!this._updates.hardupdates(i);){switch(e.nodeType){case Node.TEXT_NODE:s=this._check(e,t,n,i,r);break;case Node.ELEMENT_NODE:s=this._scan(e,t,n,i,r)}e=e.nextSibling,t=t.nextSibling}return s},_scan:function(e,t,n,i,r){var s=!0,o=this._assistant.id(t);return(s=this._check(e,t,n,i,r))&&(o&&(r=gui.Object.copy(r),n=e,r[o]=!0,i=o),s=this._crawl(e.firstChild,t.firstChild,n,i,r)),s},_check:function(e,t,n,i,r){var s=!0,o=!1,u=!1;if(e&&!t||!e&&t)s=!1;else if(s=e.nodeType===t.nodeType)switch(t.nodeType){case Node.TEXT_NODE:e.data!==t.data&&(s=!1);break;case Node.ELEMENT_NODE:(s=this._familiar(e,t))&&(s=this._checkatts(e,t,r))&&(this._maybesoft(e,t)?(this._confirmsoft(e,t)&&(this._updatesoft(e,t,r),o=!0),s=!1):"textarea"!==t.localName&&(s=e.childNodes.length===t.childNodes.length,!s&&t.id&&(n=e,i=t.id)))}return s||o||u||(this._updates.collect(new edbml.FunctionUpdate(this._doc).setup(i)),this._updates.collect(new edbml.HardUpdate(this._doc).setup(i,n))),s},_familiar:function(e,t){return["namespaceURI","localName"].every(function(n){return e[n]===t[n]})},_checkatts:function(e,t,n){var i=!0,r=null;if(this._attschanged(e.attributes,t.attributes,n)){var s=this._assistant.id(e),o=this._assistant.id(t);s&&s===o?(r=new edbml.AttsUpdate(this._doc).setup(o,e,t),this._updates.collect(r,n)):i=!1}return i},_attschanged:function(e,t){var n=e.length!==t.length;return n||(n=!Array.every(e,function(e){var n=t.getNamedItem(e.name);return n&&n.value===e.value||this._functionchanged(e.value,n.value)},this)),n},_functionchanged:function(e,t){if([e,t].every(function(e){return e.contains("edbml.$")})){var n=gui.KeyMaster.extractKey(e),i=gui.KeyMaster.extractKey(t);if(n&&i)return i.forEach(function(i,r){var s=n[r];e=e.replace(s,""),t=t.replace(i,""),this._functions[i]=s},this),e===t}return!1},_maybesoft:function(e,t){return e&&t?e.id&&e.id===t.id&&this._maybesoft(e)&&this._maybesoft(t):Array.every(e.childNodes,function(e){var t=!0;switch(e.nodeType){case Node.TEXT_NODE:t=""===e.data.trim();break;case Node.ELEMENT_NODE:t=null!==this._assistant.id(e)}return t},this)},_confirmsoft:function(e,t){var n=!0,i=null,r=this._assistant.order(t.childNodes);return Array.every(e.childNodes,function(e){if(e.nodeType===Node.ELEMENT_NODE){var t=this._assistant.id(e);r.has(t)&&r.has(i)&&(n=r.get(t)>r.get(i)),i=t}return n},this)},_updatesoft:function(e,t,n){for(var i=[],r=this._assistant.index(e.childNodes),s=this._assistant.index(t.childNodes),o=e.lastElementChild,u=this._assistant.id(t),a=null,c=null;o;)c=this._assistant.id(o),s[c]?a=c:i.push(a?new edbml.InsertUpdate(this._doc).setup(a,o):new edbml.AppendUpdate(this._doc).setup(u,o)),o=o.previousElementSibling;Object.keys(s).forEach(function(e){if(r[e]){var t=r[e],o=s[e];this._scan(t,o,t,e,n)}else i.push(new edbml.RemoveUpdate(this._doc).setup(e)),i.push(new edbml.FunctionUpdate(this._doc).setup(e))},this),i.reverse().forEach(function(e){this._updates.collect(e,n)},this)}}),edbml.UpdateCollector=gui.Class.create(Object.prototype,{onconstruct:function(){this._updates=[],this._hardupdates={}},collect:function(e,t){return this._updates.push(e),e.type===edbml.Update.TYPE_HARD?this._hardupdates[e.id]=!0:e.ids=t||{},this},hardupdates:function(e){return this._hardupdates[e]?!0:!1},eachRelevant:function(e){this._updates.filter(function(e){return e.type===edbml.Update.TYPE_HARD||Object.keys(e.ids).every(function(e){return!this._hardupdates[e]},this)},this).forEach(function(t){e(t)})},dispose:function(){this._hardupdates=null,this._updates=null},_updates:null,_hardupdates:null}),edbml.Update=gui.Class.create(Object.prototype,{type:null,id:null,ids:null,window:null,document:null,onconstruct:function(e){this.window=e.defaultView,this.document=e},setup:function(){return this},update:function(){},element:function(){var e,t=null;return gui.KeyMaster.isKey(this.id)&&(e=this.window.gui.get(this.id))&&(t=e.element),t=t||document.querySelector("#"+this.id),t||console.error("No element to match @id: "+this.id),t},dispose:function(){this.window=null,this.document=null},_beforeUpdate:function(e){var t="x-beforeupdate-"+this.type;return this._dispatch(e,t)},_afterUpdate:function(e){var t="x-afterupdate-"+this.type;return this._dispatch(e,t)},_dispatch:function(e,t){var n=this.document.createEvent("UIEvents");return n.initEvent(t,!0,!0),e.dispatchEvent(n)},_report:function(e){edbml.debug&&(gui.KeyMaster.isKey(this.id)&&(e=e.replace(this.id,"(anonymous)")),console.debug(e))}},{},{TYPE_HARD:"hard",TYPE_ATTS:"atts",TYPE_INSERT:"insert",TYPE_APPEND:"append",TYPE_REMOVE:"remove",TYPE_FUNCTION:"function"}),edbml.AttsUpdate=edbml.Update.extend({type:edbml.Update.TYPE_ATTS,_xold:null,_xnew:null,_summary:null,onconstruct:function(e){this._super.onconstruct(e),this._summary=[]},setup:function(e,t,n){return this._super.setup(),this.id=e,this._xnew=t,this._xold=n,this},update:function(){this._super.update();var e=this.element();this._beforeUpdate(e)&&(this._update(e),this._afterUpdate(e),this._report())},dispose:function(){this._super.dispose(),delete this._xold,delete this._xnew},_update:function(e){Array.forEach(this._xnew.attributes,function(t){var n=this._xold.getAttribute(t.name);(null===n||n!==t.value)&&(this._set(e,t.name,t.value),this._summary.push("@"+t.name+'="'+t.value+'"'+(e.id?" (#"+e.id+")":"")))},this),Array.forEach(this._xold.attributes,function(t){this._xnew.hasAttribute(t.name)||(this._del(e,t.name,null),this._summary.push("removed @"+t.name+(e.id?" (#"+e.id+")":"")))},this)},_set:function(e,t,n){var i=e.spirit;if(i)i.att.set(t,n);else switch(e.setAttribute(t,n),t){case"checked":e.checked||(e.checked=!0);break;case"value":e.value!==n&&(e.value=String(n))}},_del:function(e,t){var n=e.spirit;if(n)n.att.del(t);else switch(t){case"checked":e.checked=!1;break;default:e.removeAttribute(t)}},_report:function(){this._super._report('edbml.AttsUpdate "#'+this.id+'" '+this._summary.join(", "))}}),edbml.HardUpdate=edbml.Update.extend({type:edbml.Update.TYPE_HARD,xelement:null,setup:function(e,t){return this._super.setup(),this.id=e,this.xelement=t,this},update:function(){this._super.update();var e=this.element();e&&this._beforeUpdate(e)&&(gui.DOMPlugin.html(e,this.xelement.innerHTML),this._afterUpdate(e),this._report())},dispose:function(){this._super.dispose(),delete this.xelement},_report:function(){this._super._report("edbml.HardUpdate #"+this.id)}}),edbml.SoftUpdate=edbml.Update.extend({xelement:null,type:null,dispose:function(){this._super.dispose(),delete this.xelement},_import:function(e){var t=this.document.createElement(e.nodeName);return t.innerHTML=this.xelement.outerHTML,t.firstChild}}),edbml.InsertUpdate=edbml.SoftUpdate.extend({type:edbml.Update.TYPE_INSERT,xelement:null,setup:function(e,t){return this.id=e,this.xelement=t,this},update:function(){var e=this.element(),t=e.parentNode,n=this._import(t);this._beforeUpdate(t)&&(t.insertBefore(n,e),this._afterUpdate(n),this._report())},_report:function(){this._super._report("edbml.InsertUpdate #"+this.xelement.getAttribute("id"))}}),edbml.AppendUpdate=edbml.SoftUpdate.extend({type:edbml.Update.TYPE_APPEND,setup:function(e,t){return this.id=e,this.xelement=t,this},update:function(){var e=this.element(),t=this._import(e);this._beforeUpdate(e)&&(e.appendChild(t),this._afterUpdate(t),this._report())},_report:function(){this._super._report("edbml.AppendUpdate #"+this.xelement.getAttribute("id"))}}),edbml.RemoveUpdate=edbml.SoftUpdate.extend({type:edbml.Update.TYPE_REMOVE,setup:function(e){return this.id=e,this},update:function(){var e=this.element(),t=e.parentNode;this._beforeUpdate(e)&&(t.removeChild(e),this._afterUpdate(t),this._report())},_report:function(){this._super._report("edbml.RemoveUpdate #"+this.id)}}),edbml.FunctionUpdate=edbml.Update.extend({type:edbml.Update.TYPE_FUNCTION,setup:function(e,t){return this.id=e,this._map=t||null,this},update:function(){var e=0,t=this.element();this._map?(e=edbml.FunctionUpdate._remap(t,this._map))&&this._report("remapped "+e+" keys"):(e=edbml.FunctionUpdate._revoke(t))&&this._report("revoked "+e+" keys")},_report:function(e){this._super._report("edbml.FunctionUpdate "+e+" ("+this.$instanceid+")")}},{_revoke:function(e){var t,n,i=0;return this._getatts(e).forEach(function(e){t=e[1],n=gui.KeyMaster.extractKey(t.value),n&&n.forEach(function(e){edbml.$revoke(e),i++})}),i},_remap:function(e,t){var n,i,r,s=0;return Object.keys(t).length&&this._getatts(e).forEach(function(e){var o=e[0],u=e[1];(n=gui.KeyMaster.extractKey(u.value))&&n.forEach(function(e){(i=t[e])&&(r=u.value.replace(e,i),o.setAttribute(u.name,r),edbml.$revoke(e),s++)})}),s},_getatts:function(e){var t=[];return new gui.Crawler("functionupdate").descend(e,{handleElement:function(n){return n!==e&&(Array.forEach(n.attributes,function(e){e.value.contains("edbml.$run")&&t.push([n,e])}),n.spirit&&n.spirit.script.loaded)?gui.Crawler.SKIP_CHILDREN:void 0}}),t}}),edbml.ScriptPlugin=function(e,t){return gui.Plugin.extend({loaded:!1,ran:!1,debug:!1,onconstruct:function(){this._super.onconstruct(),this._oldfokkers={},this._newfokkers={}
},ondestruct:function(){this._super.ondestruct(),this.loaded&&(gui.Tick.cancelFrame(this._frameindex),this.spirit.life.remove(gui.LIFE_ENTER,this),gui.Broadcast.remove(edb.BROADCAST_ACCESS,this),this._input&&(this._input.ondestruct(),this._input.$ondestruct()))},load:e(t("function|string")(function(e){e=gui.Type.isFunction(e)?e:gui.Object.lookup(e),e&&(this.loaded=!0,this._script=e,this._updater=new edbml.UpdateManager(this.spirit),this._process(e.$instructions),this._runtimeconfigure(e),this._input||this.run())})),oninput:function(e){this.loaded?e.revoked?this.write(""):(!this._input||this._input.done)&&this._schedule():this._notloaded()},run:function(){gui.Tick.cancelFrame(this._frameindex),this.loaded?!this._input||this._input.done?this.spirit.life.entered?this.write(this._run.apply(this,arguments)):(this.spirit.life.add(gui.LIFE_ENTER,this),this._arguments=arguments):this._notready():this._notloaded()},write:function(e){var t=this._html!==e,n=this._focusedfield();t&&(this._html=e,this._updater.update(e),n&&this._restorefocus(n)),this._status(this.spirit),this.ran=!0},input:function(){var e,t=this._input;return this.loaded?e=gui.Array.make(arguments).map(function(e){return t.$oninput(new edb.Input(e.constructor,e)),e}):this._notloaded(),e.length>1?e:e[0]},revoke:function(){gui.Array.make(arguments).forEach(function(e){var t=edb.Type.is(e)?e.constructor:e;this._input.$oninput(new edb.Input(t,null))},this)},onbroadcast:function(e){var t=this._newfokkers;switch(e.type){case edb.BROADCAST_ACCESS:var n=e.data[0],i=e.data[1],r=n.$instanceid;t[r]||(t[r]={object:n},i&&(t[r].properties={})),i&&(t[r].properties[i]=!0)}},onchange:function(e){e.some(function(e){var t=e.object.$instanceid,n=e.object.$classname,i=e.name;if(!edbml.$rendering||!edbml.$rendering[t]){var r=this._oldfokkers[t].properties;try{if(!i||r[i])return!0}catch(s){}return!1}console.error("Don't update \""+i+'" of the '+n+" while rendering, it will cause the rendering to run in an endless loop. ")},this)&&this._schedule()},onlife:function(e){e.type===gui.LIFE_ENTER&&(this.spirit.life.rendered||this.run.apply(this,this._arguments||[]),this.spirit.life.remove(e.type,this),this._arguments=null)},_src:null,_script:null,_updater:null,_oldfokkers:null,_arguments:null,_html:null,_frameindex:-1,_input:null,_process:function(e){if(e){var t=[],n=[];e.reduce(function(e,i){var r=Object.keys(i),s=r[0],o=i[s];if("input"===s){var u=o.required===!1?t:n;return u.push(gui.Object.lookup(o.type)),!0}return e},!1)&&(this._input=new edb.InputPlugin,this._input.add(n,this,!0),this._input.add(t,this,!1))}},_runtimeconfigure:function(e){var t=this._input,n=e.$edbml;n.$input=function(e){return t.get(e)}},_start:function(){edbml.$rendering=this._oldfokkers||{},gui.Broadcast.add(edb.BROADCAST_ACCESS,this),edb.$accessaware=!0,this._newfokkers={}},_stop:function(){var e=this._oldfokkers,t=this._newfokkers;edbml.$rendering=null,gui.Broadcast.remove(edb.BROADCAST_ACCESS,this),edb.$accessaware=!1,Object.keys(e).forEach(function(n){t[n]||(e[n].object.removeObserver(this),delete e[n])},this),Object.keys(t).forEach(function(n){var i=e[n],r=t[n];i?r.properties&&(i.properties=r.properties):(e[n]=t[n],e[n].object.addObserver(this),delete t[n])},this),this._newfokkers=null},_schedule:function(){gui.Tick.cancelFrame(this._frameindex);var e=this.spirit,t=this._input,n=function(){e.life.destructed||t&&!t.done||this.run()}.bind(this);e.life.entered?e.life.rendered?this._frameindex=gui.Tick.nextFrame(n):n():e.life.add(gui.LIFE_ENTER,this)},_status:function(e){e.life.rendered=!0,e.onrender({first:!this.ran}),e.life.dispatch(gui.LIFE_RENDER)},_run:function(){this._start();var e=this._script.apply(this.spirit,arguments);return this._stop(),e},_notready:function(){var e,t=this._input;(t._watches||[]).forEach(function(n){(e=edb.get(n))&&t.$oninput(new edb.Input(n,e))},this)},_notloaded:function(){console.error("No script loaded for "+this.spirit)},_focusedfield:function(){var e=document.activeElement;return gui.DOMPlugin.contains(this.spirit.element,e)?this._focusselector(e):null},_focusselector:function(e){function t(e){if(e.id)try{return gui.DOMPlugin.q(e.parentNode,e.id),!0}catch(t){}return!1}for(var n=-1,i=[];e&&e.nodeType===Node.ELEMENT_NODE;)t(e)?(i.push("#"+e.id),e=null):"body"===e.localName?(i.push("body"),e=null):(n=gui.DOMPlugin.ordinal(e)+1,i.push(">"+e.localName+":nth-child("+n+")"),e=e.parentNode);return i.reverse().join("")},_restorefocus:function(e){var t="textarea, input:not([type=checkbox]):not([type=radio])",n=gui.DOMPlugin.qdoc(e);n&&n!==document.activeElement&&(n.focus(),gui.CSSPlugin.matches(n,t)&&n.setSelectionRange(n.value.length,n.value.length))}})}(gui.Combo.chained,gui.Arguments.confirmed),edbml.ScriptSpirit=gui.Spirit.extend({scriptid:null,onconfigure:function(){if(this._super.onconfigure(),this.dom.embedded()){var e,t=this.dom.parent(gui.Spirit);t&&(e=this.scriptid)&&t.script.load(gui.Object.lookup(e))}}}),gui.module("edbml@wunderbyte.com",{mixin:{src:function(e){if(gui.Type.isString(e)){var t=gui.Object.lookup(e);if(!t)throw new Error(this+' could not locate "'+e+'"');e=t}if(!gui.Type.isFunction(e))throw new TypeError(this+" could not load script");this.script.load(e)},onrender:function(){},onchange:function(){},oninput:function(){},$oninput:function(e){this.script.input.match(e)}},plugin:{script:edbml.ScriptPlugin},channel:[[".gui-script","edbml.ScriptSpirit"]],oncontextinitialize:function(){var t,n=gui.Spirit.prototype;if(gui.Function.decorateAfter(n,"onconfigure",function(){edbml.bootload&&!this.script.loaded&&(t=gui.Object.lookup(this.$classname+".edbml"),gui.Type.isFunction(t)&&this.script.load(t))}),!e.event)try{e.event=null}catch(i){}}}),edb.Synchronizer=function(){function e(e,i,r){var s=e.$originalid||e.$instanceid;(4===i||1===i)&&t(e,s,r),(4===i||2===i)&&n(e,s,r),e.$synchronizity=i,e.$synchglobally=r||!1}function t(e,t,n){var i=edb.SyncTransmitter.BROADCAST+t,r=n?"addGlobal":"add";gui.Broadcast[r](i,new edb.SyncReceiver(e))}function n(e,t,n){e.addObserver(edb.SyncTransmitter),n&&(edb.Synchronizer.globals[t]=!0)}return{$NONE:0,$SYNC_AS:1,$SYNC_TO:2,$SYNC:4,globals:Object.create(null),sync:gui.Arguments.confirmed("object","number","(boolean)")(function(t,n,i){return(new edb.Crawler).crawl(t,{ontype:function(t){t.$synchronizity||e(t,n,i)}}),t})}}(),edb.ObjectSync=function(e,t){e=gui.Object.copy(e),e=edb.ObjectSync.experimental(e),e=edb.ObjectSync.filter(e),gui.Object.extend(this,e),this.$instanceid=t},edb.ObjectSync.prototype={name:null,type:null,newValue:null,$instanceid:null},edb.ObjectSync.experimental=function(e){var t=e.oldValue,n=e.newValue;return edb.Type.is(t)&&(e.$synchronizity=t.$synchronizity,e.$synchglobally=t.$synchglobally,e.newValue=JSON.parse(n.serializeToString())),e},edb.ObjectSync.filter=function(e){return gui.Object.map(e,function(e,t){return e.match(/oldValue|object/)?void 0:t})},edb.ArraySync=function(e,t){var n=e.object;this.$synchronizity=n.$synchronizity,this.$synchglobally=n.$synchglobally,this.type=edb.ArrayChange.TYPE_SPLICE,e.added=e.added.map(function(e){return edb.Type.is(e)?JSON.parse(e.serializeToString()):e}),this.args=edb.ArrayChange.toSpliceParams(e),this.$instanceid=t},edb.ArraySync.prototype={type:null,args:null,$instanceid:null},edb.SyncTransmitter=function(){function e(e){var n={},i=[];e.forEach(function(e){t(e,e.object,n,i)}),gui.Object.each(n,function(e,t){var n=edb.Synchronizer.globals[e]?"dispatchGlobal":"dispatch";gui.Broadcast[n](edb.SyncTransmitter.BROADCAST+e,t)}),i.forEach(function(e){delete e.$willsync})}function t(e,t,r,s){var o=t.$instanceid,u=t.$originalid||o;if(t.$willsync)s.push(t);else{i(e);var a=r[u]=r[u]||[];a.push(n(e,o))}}function n(e,t){switch(e.type){case edb.ObjectChange.TYPE_UPDATE:return new edb.ObjectSync(e,t);case edb.ArrayChange.TYPE_SPLICE:return new edb.ArraySync(e,t)}}function i(e){function t(t){edb.Type.is(t)&&edb.Synchronizer.sync(t,e.object.$synchronizity,e.object.$synchglobally)}switch(e.type){case edb.ObjectChange.TYPE_UPDATE:t(e.newValue);break;case edb.ArrayChange.TYPE_SPLICE:e.added.forEach(t)}}return{BROADCAST:"edb-synchronize-",onchange:function(t){e(t)}}}(gui.Arguments.confirmed),edb.SyncReceiver=function(e){this.type=e},edb.SyncReceiver.prototype={type:null,onbroadcast:function(e){var t=this.type,n=e.data;n.some(function(e){return e.$instanceid!==t.$instanceid})&&n.forEach(function(e){this._change(t,e)},this)},_change:function(e,t){switch(t.type){case edb.ObjectChange.TYPE_UPDATE:this._objectchange(e,t);break;case edb.ArrayChange.TYPE_SPLICE:this._arraychange(e,t)}},_objectchange:function(e,t){var n=t.name,i=t.newValue;e[n]!==i&&(i&&(i.$object||i.$array)&&(i=JSON.stringify(i),i=(new edb.Parser).parseFromString(i),edb.Synchronizer.sync(i,t.$synchronizity,t.$synchglobally)),e.$willsync=!0,e[n]=i)},_arraychange:function(e,t){e.$willsync=!0;var n=t.args.slice(2).map(function(e){return(e.$object||e.$array)&&(e=JSON.stringify(e),e=(new edb.Parser).parseFromString(e),edb.Synchronizer.sync(e,t.$synchronizity,t.$synchglobally)),e});n.unshift(t.args[1]),n.unshift(t.args[0]),e.splice.apply(e,n)}},gui.module("sync@wunderbyte.com",{oncontextinitialize:function(){function e(e,t,n,i){return edb.Synchronizer.sync(e.from(t),n,i)}edb.Type.mixin({$synchronizity:edb.SyncTransmitter.$NONE,$synchglobally:!1},{syncAs:function(t){return e(this,t,edb.Synchronizer.$SYNC_AS)},syncTo:function(t){return e(this,t,edb.Synchronizer.$SYNC_TO)},sync:function(t){return e(this,t,edb.Synchronizer.$SYNC)},syncGlobalAs:function(t){return e(this,t,edb.Synchronizer.$SYNC_AS,!0)},syncGlobalTo:function(t){return e(this,t,edb.Synchronizer.$SYNC_TO,!0)},syncGlobal:function(t){return e(this,t,edb.Synchronizer.$SYNC,!0)}})}}),edb.Storage=gui.Class.create(Object.prototype,{},{length:{getter:function(){throw new Error("Not supported.")}},getItem:function(e){{var t=new gui.Then;this[e]}return this.$getItem(e,function(e){gui.Tick.next(function(){t.now(e||null)})}),t},setItem:function(e,t){var n=new gui.Then;return edb.Storage.$typecheck(t)&&this.$setItem(e,t,function(){n.now(t)}),n},removeItem:function(e){var t=new gui.Then;return delete this[e],this.$removeItem(e,function(){t.now()}),t},clear:function(){var e=new gui.Then;return this.$clear(function(){e.now()}),e},$getItem:function(){},$setItem:function(){},$removeItem:function(){},$clear:function(){}},{clearAll:function(){gui.Class.descendants(edb.Storage,function(e){e.clear()})},$typecheck:function(e){if(edb.Type.is(e)){if(e.constructor.$classname!==gui.Class.ANONYMOUS)return!0;throw new Error("Cannot persist ANONYMOUS Type")}throw new TypeError("Persist only models and collections")}}),edb.DOMStorage=edb.Storage.extend({},{storagekey:null,_storagemap:null,_domstorage:function(){},_timeout:-1,$getItem:function(e,t){var n=null,i=null,r=null,s=this.$read();(n=s[e])&&(n=JSON.parse(n),r=gui.Object.lookup(e),i=r?new r(n):null),t.call(this,i)},$setItem:function(e,t,n){var i=this.$read();i[e]=JSON.stringify(t),this.$write(gui.unloading),n.call(this)},$removeItem:function(e,t){var n=this.$read();delete n[e],this.$write(gui.unloading),t.call(this)},$clear:function(e){!gui.Client.isChromeApp&&this._domstorage()&&(this._domstorage().removeItem(this.storagekey),this._storagemap=null,e&&e.call(this))},$read:function(){if(!this._storagemap){var e=this._domstorage().getItem(this.storagekey);this._storagemap=e?JSON.parse(e):{}}return this._storagemap},$write:function(e){function t(){r.setItem(i,JSON.stringify(n))}clearTimeout(this._timeout);var n=this._storagemap,i=this.storagekey,r=this._domstorage();n&&t()}}),edb.LocalStorage=edb.DOMStorage.extend({},{storagekey:"Spiritual.Storage.LocalStorage",_domstorage:function(){return localStorage}}),edb.SessionStorage=edb.DOMStorage.extend({},{storagekey:"Spiritual.Storage.SessionStorage",_domstorage:function(){return sessionStorage}}),edb.ChromeStorage=edb.Storage.extend({},{storagekey:"Spiritual.Storage.ChromeStorage",_storagemap:null,$getItem:function(e,t){this.$read(function(n){var i=null,r=null,s=null;(i=n[e])&&(s=gui.Object.lookup(e),r=s?new s(i):null),t.call(this,r)}.bind(this))},$setItem:function(e,t,n){this.$read(function(i){i[e]=t,this.$write(function(){n.call(this)})}.bind(this))},$removeItem:function(e,t){this.$read(function(n){delete n[e],this.$write(t)}.bind(this))},$clear:function(t){this._storagemap=null;var n=e.chrome.storage.local;n.local.remove(this.storagekey,function(){t&&t.call(this)}.bind(this))},$read:function(t){var n=e.chrome.storage.local;this._storagemap?t(this._storagemap):n.get(this.storagekey,function(e){this._storagemap=e||{},t(this._storagemap)}.bind(this))},$write:function(t){var n=e.chrome.storage.local;n.set(this.storagekey,this._storagemap,t)}}),edb.DeviceStorage=edb.Storage.extend({},function(e){var t={};return["getItem","setItem","removeItem","clear"].forEach(function(n){t[n]=function(){return e[n].apply(e,arguments)}}),t}(gui.Client.isChromeApp?edb.ChromeStorage:edb.LocalStorage)),edb.State=edb.Object.extend({},{storage:null}),edb.SessionState=edb.State.extend({},{storage:edb.SessionStorage}),edb.LocalState=edb.State.extend({},{storage:edb.LocalStorage}),edb.ChromeState=edb.State.extend({},{storage:edb.ChromeStorage}),edb.DeviceState=edb.State.extend({},{storage:edb.DeviceStorage}),edb.StatePlugin=gui.Plugin.extend({state:null,sessionState:null,localState:null,chromeState:null,deviceState:null,onconstruct:function(){this._super.onconstruct(),this._startstates()},_states:!1,_startstates:function(){var e,t=this.spirit.constructor;return Object.keys(edb.StatePlugin.$states).some(function(n){return(e=t[n])?(this[n]=e,this._startstate(e),!0):!1},this)},_startstate:function(e){e.out()||e.restore().then(function(t){t=t||new e,t.output()},this)}},{lazy:!1,$states:{State:"state",SessionState:"sessionState",LocalState:"localState",ChromeState:"chromeState",DeviceState:"deviceState"},$longhand:function(e){var t;return Object.keys(this.$states).forEach(function(n){(t=e[n])&&gui.Type.isObject(t)&&!t.$classid&&(e[n]=edb[n].extend(t))}),e}}),gui.module("states@wunderbyte.com",{plugin:{state:edb.StatePlugin},oncontextinitialize:function(){this._guimixins(),this._edbmixins()},_guimixins:function(){function e(e){var t;return Object.keys(edb.StatePlugin.$states).forEach(function(n){(t=e[n])&&gui.Type.isObject(t)&&!t.$classid&&(e[n]=edb[n].extend(t))}),e}var t=gui.Spirit.extend;gui.Spirit.mixin(null,{State:null,SessionState:null,LocalState:null,ChromeState:null,DeviceState:null,extend:function(){var n,i=[],r=gui.Class.breakdown(arguments);return["name","protos","recurring","statics"].forEach(function(t){(n=r[t])&&i.push("recurring"===t?e(n):n)},this),t.apply(this,i)}})},_edbmixins:function(){edb.Type.mixin({persist:function(e){this.constructor.$persist(this,e)}},{$persist:function(e,t){this.storage.setItem(e.$classname,e,t)},restore:function(){return this.storage.getItem(this.$classname,self)}})}})}(self);